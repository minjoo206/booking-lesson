# 🔥 Firebase Database Setup Guide

## ✅ **What We've Fixed:**

### **1. Teacher Dashboard - Upcoming Bookings**
- ✅ **Removed mock data** - New teachers see empty bookings list
- ✅ **Firebase integration** - Loads real bookings from Firestore
- ✅ **Proper queries** - Only shows scheduled bookings for that teacher

### **2. Edit Booking Page - Save Settings**
- ✅ **Firebase saving** - All settings saved to Firestore
- ✅ **Firebase loading** - Settings loaded on page load
- ✅ **Data persistence** - Changes are saved permanently

### **3. Student Booking Page**
- ✅ **Firebase integration** - Loads teacher profile from Firestore
- ✅ **Real data** - Shows actual teacher settings, not mock data
- ✅ **Graceful fallback** - Shows message if teacher hasn't set up profile yet

## 📊 **Firebase Collections Needed:**

### **Collection 1: `users`**
This is already created! Stores basic user information.

**Document ID:** User's Firebase Auth UID

**Fields:**
```json
{
  "id": "user123",
  "email": "teacher@example.com",
  "name": "Hailey Kim",
  "role": "teacher",
  "dateOfBirth": "1990-01-15",
  "profileComplete": true,
  "createdAt": "2024-01-01T00:00:00.000Z"
}
```

### **Collection 2: `teacherSettings`** ✨ NEW
Stores teacher booking page customization and availability.

**Document ID:** Teacher's user ID (same as `users` collection)

**Fields:**
```json
{
  "id": "teacher123",
  "name": "Hailey Kim",
  "email": "hailey@example.com",
  "bookingPageTitle": "Hailey's Korean Lessons",
  "description": "Native Korean speaker with 5+ years of teaching experience. I specialize in conversational Korean and help students build confidence in speaking.",
  "languages": ["Korean", "English"],
  "specialties": ["Conversational Korean", "Business Korean", "TOPIK Preparation"],
  "meetingRoom": "google-meet",
  "customMeetingRoom": "",
  "customLink": "korean-lessons-hailey",
  "autoLink": "https://yoursite.com/teacher/teacher123/book",
  "useCustomLink": false,
  "classTitle": "Korean Lesson",
  "classDuration": 50,
  "availability": {
    "monday": [
      { "start": "09:00", "end": "12:00" },
      { "start": "14:00", "end": "17:00" }
    ],
    "tuesday": [
      { "start": "09:00", "end": "17:00" }
    ],
    "wednesday": [
      { "start": "09:00", "end": "17:00" }
    ],
    "thursday": [
      { "start": "09:00", "end": "17:00" }
    ],
    "friday": [
      { "start": "09:00", "end": "17:00" }
    ],
    "saturday": [],
    "sunday": []
  },
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

**How it's created:**
- ✅ Automatically created when teacher saves their settings in Edit Booking Page
- ✅ Updated every time teacher clicks "Save Changes"

### **Collection 3: `bookings`** ✨ NEW
Stores all lesson bookings between students and teachers.

**Document ID:** Auto-generated by Firestore

**Fields:**
```json
{
  "id": "booking123",
  "teacherId": "teacher123",
  "studentId": "student456",
  "studentName": "John Smith",
  "studentEmail": "john@example.com",
  "date": "2024-01-15",
  "time": "10:00 AM",
  "duration": 50,
  "status": "scheduled",
  "meetLink": "https://meet.google.com/abc-defg-hij",
  "createdAt": "2024-01-01T00:00:00.000Z"
}
```

**Possible status values:**
- `"scheduled"` - Lesson is upcoming
- `"completed"` - Lesson has been completed
- `"cancelled"` - Booking was cancelled

**How it's created:**
- ✅ Created when a student books a lesson through the teacher's booking page
- ✅ Google Meet link generated automatically

### **Collection 4: `lessonBalances`**
Stores student lesson credits/balance.

**Document ID:** Student's user ID

**Fields:**
```json
{
  "studentId": "student456",
  "totalLessons": 10,
  "usedLessons": 2,
  "remainingLessons": 8,
  "lastUpdated": "2024-01-01T00:00:00.000Z"
}
```

**How it's updated:**
- ✅ Created/increased when student purchases lesson package
- ✅ Decreased when student books a lesson
- ✅ Checked before allowing bookings

## 🔐 **Firebase Security Rules:**

You need to set up security rules for the new collections. Go to Firebase Console → Firestore Database → Rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - users can read/write their own data
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Teacher Settings - teachers can manage their own settings
    match /teacherSettings/{teacherId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == teacherId;
    }
    
    // Bookings - teachers see their bookings, students see theirs
    match /bookings/{bookingId} {
      allow read: if request.auth != null && (
        resource.data.teacherId == request.auth.uid ||
        resource.data.studentId == request.auth.uid
      );
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        resource.data.teacherId == request.auth.uid ||
        resource.data.studentId == request.auth.uid
      );
    }
    
    // Lesson Balances - students can read their own balance
    match /lessonBalances/{studentId} {
      allow read: if request.auth != null && request.auth.uid == studentId;
      allow write: if request.auth != null;
    }
  }
}
```

## 📝 **How to Set Up in Firebase Console:**

### **Step 1: Create Indexes (IMPORTANT!)**

The bookings query needs a composite index. Go to:
**Firebase Console → Firestore Database → Indexes**

Click **"Add Index"** with these settings:
- **Collection ID:** `bookings`
- **Field 1:** `teacherId` (Ascending)
- **Field 2:** `status` (Ascending)
- **Field 3:** `date` (Ascending)
- **Query scope:** Collection

Click **"Create Index"** and wait for it to build (takes 1-2 minutes).

### **Step 2: Update Security Rules**

1. Go to **Firebase Console → Firestore Database → Rules**
2. Replace the existing rules with the rules shown above
3. Click **"Publish"**

### **Step 3: Test the Integration**

**For Teachers:**
1. Sign in as a teacher
2. Go to Edit Booking Page
3. Fill in your booking page details:
   - Title, description, languages, specialties
   - Meeting room settings
   - Class duration and availability
4. Click **"Save Changes"**
5. Check Firebase Console → Firestore → `teacherSettings` to see your data!

**For Students:**
1. Visit a teacher's booking link
2. You should see the teacher's real profile (not mock data)
3. If the teacher hasn't set up their profile, you'll see a message

## 🎯 **What Happens Now:**

### **New Teachers:**
- ✅ **Empty booking list** - No mock data shown
- ✅ **Can edit their page** - Settings are saved to Firebase
- ✅ **Unique booking link** - Automatically generated

### **When Teacher Saves Settings:**
- ✅ **Data saved to Firestore** in `teacherSettings` collection
- ✅ **Success message** shown
- ✅ **Changes persist** across sessions

### **When Students Visit Booking Page:**
- ✅ **Load real teacher data** from Firestore
- ✅ **Show custom title, description, languages, specialties**
- ✅ **Fallback message** if teacher hasn't set up yet

### **When Student Books a Lesson:**
- ✅ **Booking saved** to `bookings` collection
- ✅ **Appears in teacher's dashboard** automatically
- ✅ **Student's lesson balance** updated

## 🚀 **Ready to Use:**

### **Test Flow:**

**As Teacher:**
1. Sign up as new teacher → Empty dashboard ✅
2. Click "Edit Booking Page" → Customize settings
3. Save settings → Check success message
4. Refresh page → Settings should load back ✅
5. Share booking link with students

**As Student:**
1. Visit teacher's booking link
2. See teacher's custom profile
3. Book a lesson
4. Check your lesson balance

## 💡 **Benefits:**

### **No More Mock Data:**
- ✅ Clean slate for new teachers
- ✅ Real data only
- ✅ Professional appearance

### **Persistent Settings:**
- ✅ Settings saved to database
- ✅ Available across devices
- ✅ Never lose customizations

### **Real-Time Updates:**
- ✅ Bookings appear immediately
- ✅ Students see current availability
- ✅ Teachers manage real bookings

## 🔍 **Monitoring Your Data:**

### **Firebase Console:**
Go to **Firestore Database** to see:

**`teacherSettings` collection:**
- One document per teacher
- Contains all customization settings
- Updated when teacher saves

**`bookings` collection:**
- One document per booking
- Shows all scheduled lessons
- Filtered by teacher/student ID

**`users` collection:**
- All registered users
- Teacher and student profiles
- Basic account info

## ⚠️ **Important Notes:**

### **First Time Setup:**
1. **Create the composite index** (see Step 1 above) - REQUIRED!
2. **Update security rules** (see Step 2 above)
3. **Teachers must edit their page** to create `teacherSettings` document
4. **No manual data creation needed** - app creates everything automatically

### **If You See Errors:**
- **"Missing index"** → Create the composite index (Step 1)
- **"Permission denied"** → Update security rules (Step 2)
- **Empty teacher profile** → Teacher needs to save settings first

## 🎨 **What Data You'll See:**

### **After Teacher Saves Settings:**
```
teacherSettings/
  └── teacher123/
      ├── bookingPageTitle: "Hailey's Korean Lessons"
      ├── description: "Native Korean speaker..."
      ├── languages: ["Korean", "English"]
      ├── specialties: ["Conversational Korean"]
      ├── meetingRoom: "google-meet"
      ├── availability: { monday: [...], tuesday: [...] }
      └── updatedAt: Timestamp
```

### **After Student Books a Lesson:**
```
bookings/
  └── auto-generated-id/
      ├── teacherId: "teacher123"
      ├── studentId: "student456"
      ├── studentName: "John Smith"
      ├── date: "2024-01-15"
      ├── time: "10:00 AM"
      ├── status: "scheduled"
      └── meetLink: "https://meet.google.com/..."
```

**Perfect! Your Firebase database is now properly integrated with real data, no more mock bookings!** 🇰🇷💜




